<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="../assets/css/dashboard.css" />
    <link rel="website icon" href="../assets/icon/owl.svg" />
    <title> Dashboard | HowlZ</title>
</head>

<body>
    <nav class="menu-lateral" id="menuLateral">
        <div class="botao-menu" onclick="botaoMenu()">
            <img src="../assets/img/menu-hamburguer.png" alt="" />
        </div>

        <div class="usuario">
            <h4 id="nomeDaEmpresa"></h4>
            <img src="../assets/img/usuario.png" alt="" />
            <h4 id="nomeDoUsuario"></h4>
        </div>

        <ul>
            <li class="item-menu">
                <a href="editGestor.html">
                    <span class="icone"><i class="bi bi-person-gear"></i></span>
                    <span class="textoEdit">Editar <img src="../assets/img/lapis.png" alt=""></span>
                </a>
            </li>
            <li class="item-menu">
                <a href="edit.html">
                    <span class="icone"><i class="bi bi-person-gear"></i></span>
                    <span class="texto">Editar funcionário</span>
                </a>
            </li>
            <li class="item-menu">
                <a href="editEmpresa.html">
                    <span class="icone"><i class="bi bi-person-gear"></i></span>
                    <span class="texto">Editar empresa</span>
                </a>
            </li>
            <li class="item-menu">
                <a href="./dashboard.html">
                    <span class="icone"><i class="bi bi-bar-chart-fill"></i></span>
                    <span class="texto">Computadores</span>
                </a>
            </li>
            <li class="item-menu">
                <a href="../cadastroNovoFunc.html">
                    <span class="icone"><i class="bi bi-person-add"></i></span>
                    <span class="texto">Novo usuário</span>
                </a>
            </li>
            <li class="item-menu">
                <a href="https://howlz.atlassian.net/servicedesk/customer/portal/1">
                    <span class="icone"><i class="bi bi-person-gear"></i></span>
                    <span class="texto">Suporte</span>
                </a>
            </li>
            <li class="item-menu">
                <a href="../login.html">
                    <span class="icone"><i class="bi bi-box-arrow-in-right"></i></span>
                    <span class="texto" onclick="limparSessao()">Sair</span>
                </a>
            </li>
        </ul>
    </nav>
    <div class="tipoAlertas" id="tipoAlertass"></div>
    <div class="alertas" id="alertass"></div>
    <div class="content">
        <h2>Máquinas Monitoradas</h2>
        <div class="container" id="maquinas" style="gap: 10px">
            <!-- <div class="maquina">
                <h3>Máquina 1</h3>
                <p class="status ativa">Status: Ativa</p>
                <p>Uso de CPU: </p>
                <p>Memória RAM: </p>
                <p>Espaço em Disco: </p>
                <a href="../dashboard/maquina.html"><button>Monitorar</button></a>
            </div> -->
        </div>
    </div>
    <script>

        //função para quebrar linha das maquinas
        // for (let i = 0; i < array.length; i++) {
        //     const element = array[i];
        //     if (i % 5 == 0){

        //     }
        // }

        sessionStorage.ID_MAQUINA = 0;

        function botaoMenu() {
            var menuLateral = document.getElementById("menuLateral");
            var botaoMenuImg = document.getElementById("botaoMenuImg");

            menuLateral.classList.toggle("ver-menu");
            botaoMenuImg.style.display = menuLateral.classList.contains("ver-menu") ? "none" : "block";

            var content = document.querySelector(".content");
            content.classList.toggle("content-shift");
        }

        var nomeDaEmpresa = sessionStorage.getItem("NOME_EMPRESA");
        document.getElementById("nomeDaEmpresa").innerHTML = nomeDaEmpresa;

        var nomeDoUsuario = sessionStorage.getItem("NOME_USUARIO");
        document.getElementById("nomeDoUsuario").innerHTML = nomeDoUsuario;

        function limparSessao() {

            sessionStorage.clear();

            window.location = "/login";
        }

        var fkGestorServer = sessionStorage.getItem("ID_USUARIO");

        async function obterDadosMaquinas() {
    try {
        const respostaContagem = await fetch("/usuarios/contar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                fkGestorServer: fkGestorServer,
            }),
        });

        if (!respostaContagem.ok) {
            throw new Error("Erro ao contar usuários");
        }

        const jsonContagem = await respostaContagem.json();

        var maquinasHTML = "";
        var vermelho = 0;
        var laranja = 0;

        for (let i = 0; i < jsonContagem; i++) {
            if (i % 5 === 0) {
                maquinasHTML += '<div class="maquinasLinha">';
            }

            const respostaIdMaquina = await fetch("/usuarios/idMaquina", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    fkGestorServer: fkGestorServer,
                    contagem: i,
                }),
            });

            if (!respostaIdMaquina.ok) {
                throw new Error("Erro ao obter ID da máquina");
            }

            const item = await respostaIdMaquina.json();

            console.log(item);
            console.log(JSON.stringify(item));

            console.log(item + "  id da maquina");

            const respostaMaquinas = await fetch("/usuarios/maquinas", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    fkMaquina: item, // colocar o Item aqui
                }),
            });

            const jsonMaquina = await respostaMaquinas.json();

            console.log(jsonMaquina);
            console.log(JSON.stringify(jsonMaquina));

            maquinasHTML += `
                <div id="maquina" class="maquina ${i % 5 === 0 ? 'primeiraNaLinha' : ''}" 
                    style="${jsonMaquina.UsoCPU > 80 ? 'border-color: red;' : ''} ${jsonMaquina.UsoCPU > 2 && jsonMaquina.UsoCPU <= 80 ? 'border-color: orange;' : ''}">
                    <h3>Máquina ${jsonMaquina.idComputador}</h3>
                    <p class="status ativa">Status: Ativa</p>
                    <p>Uso de CPU: ${jsonMaquina.UsoCPU}</p>
                    <p>Memória RAM: ${jsonMaquina.Memoria}</p>
                    <p>Espaço em Disco: ${jsonMaquina.Disco}</p>
                    <button onclick="mudarPagina(${jsonMaquina.idComputador})">Monitorar</button>
                </div>
            `;

            if (jsonMaquina.UsoCPU > 80) {
                vermelho++;
            } else if (jsonMaquina.UsoCPU > 2 && jsonMaquina.UsoCPU <= 80) {
                laranja++;
            }

            if ((i + 1) % 5 === 0) {
                maquinasHTML += '</div>';
            }

            // Certifique-se de que 'maquinas' e 'alertass' estão definidos antes de atualizá-los.
            document.getElementById('maquinas').innerHTML = maquinasHTML;
            document.getElementById('alertass').innerHTML = `
                <h3>Máquinas em Alerta</h3>
                <p style="Color: red;">Risco: <b>${vermelho}</b></p>
                <p style="Color: orange;">Alerta: <b>${laranja}</b></p>
            `;
        }

        // Certifique-se de que 'tipoAlertass' está definido antes de atualizá-lo.
        document.getElementById('tipoAlertass').innerHTML = `
            <h3>Tipo Alerta</h3>
            <p style="Color: red;">Risco <br> <b>↑80</b></p>
            <p style="Color: orange;">Alerta <br> <b>↑60 e ↓80</b></p>
        `;
    } catch (erro) {
        console.error(erro);
    }
}

function mudarPagina(idComputador) {
    sessionStorage.ID_MAQUINA = idComputador;
    window.location = "../dashboard/maquina.html";
}

// Chame a função para iniciar o processo.
obterDadosMaquinas();

    </script>
</body>

</html>

<script>


async function obterDadosMaquinas() {
    try {
        const respostaContagem = await fetch("/usuarios/contar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                fkGestorServer: fkGestorServer,
            }),
        });

        if (!respostaContagem.ok) {
            throw new Error("Erro ao contar usuários");
        }

        const jsonContagem = await respostaContagem.json();

        var maquinasHTML = "";
        var vermelho = 0;
        var laranja = 0;

        for (let i = 0; i < jsonContagem; i++) {
            if (i % 5 === 0) {
                        maquinasHTML += '<div class="maquinasLinha">';
                    }

                    fetch("/usuarios/idMaquina", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            fkGestorServer: fkGestorServer,
                            contagem: i,
                        }),
                    })
                        .then(function (retorno) {
                            if (retorno.ok) {
                                return retorno.json();
                            } else {
                                throw new Error("Erro ao obter ID da máquina");
                            }
                        })
                        .then(function (item) {
                            console.log(item);
                            console.log(JSON.stringify(item));

                            console.log(item + "  id da maquina");

                            fetch("/usuarios/maquinas", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    fkMaquina: item, // colocar o Item aqui
                                }),
                            });
                        })
                        .then(function (volta) {
                            if (volta.ok) {
                                return volta.json();
                            } else {
                                throw new Error("Erro ao obter informações da máquina");
                            }
                        })
                        .then(function (json) {
                            console.log(json);
                            console.log(JSON.stringify(json));
                            

                            maquinasHTML += `
                                <div id="maquina" class="maquina ${i % 5 === 0 ? 'primeiraNaLinha' : ''}" 
                                    style="${json.UsoCPU > 80 ? 'border-color: red;' : ''} ${json.UsoCPU > 2 && json.UsoCPU <= 80 ? 'border-color: orange;' : ''}">
                                    <h3>Máquina ${json.idComputador}</h3>
                                    <p class="status ativa">Status: Ativa</p>
                                    <p>Uso de CPU: ${json.UsoCPU}</p>
                                    <p>Memória RAM: ${json.Memoria}</p>
                                    <p>Espaço em Disco: ${json.Disco}</p>
                                    <button onclick="mudarPagina(${json.idComputador})">Monitorar</button>
                                </div>
                            `;

                            if (json.UsoCPU > 80) {
                                vermelho++;
                            } else if (json.UsoCPU > 2 && json.UsoCPU <= 80) {
                                laranja++;
                            }

                            if ((i + 1) % 5 === 0) {
                                maquinasHTML += '</div>';
                            }

                            maquinas.innerHTML = maquinasHTML;
                            alertass.innerHTML = `
                                <h3>Máquinas em Alerta</h3>
                                <p style="Color: red;">Risco: <b>${vermelho}</b></p>
                                <p style="Color: orange;">Alerta: <b>${laranja}</b></p>
                            `;
                        })
                        .catch(function (erro) {
                            console.error(erro);
                        });
        }

        tipoAlertass.innerHTML = `
            <h3>Tipo Alerta</h3>
            <p style="Color: red;">Risco <br> <b>↑80</b></p>
            <p style="Color: orange;">Alerta <br> <b>↑60 e ↓80</b></p>
        `;
    } catch (erro) {
        console.error(erro);
    }
}

obterDadosMaquinas();

</script>